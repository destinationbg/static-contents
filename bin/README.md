## Въведение

Това хранилище съдържа Python скриптове, с които официалните [ЕКАТТЕ данни](https://www.nsi.bg/nrnm/ekatte/index) от сайта на **Националния статистически институт** могат да се преобразуват в подходящ за четене формат от [Laravel приложението](https://github.com/destinationbg/backend-laravel).

За целта са свалени копия на три файла и са съхранени в папката `data`:
- `ek_obl.json` - съдържа всички области;
- `ek_obst.json` - съдържа всички общини;
- `ek_atte.json` - съдържа всички градове и села.

В допълнение там се съхранява и файл, който понастоящем няма от къде да бъде свален и генериран, а именно `municipalities_by_region.json`, който е ръчно създаден и попълнен от мен. Файлът съдържа списък с всички официални [туристически райони на страната](https://www.tourism.government.bg/bg/kategorii/strategicheski-dokumenti/koncepciya-za-turistichesko-rayonirane-na-bulgariya), след решението на **Министерство на туризма** за туристическо райониране на България, както и общините, които попадат на територията на всеки от районите.

## Генериране на файлове

Изпълнявайки `main.py` файла, можете да генерирате накуп файловете, които съхраняваме в папка `4.localities`, а именно файловете за областните градове, общините, градовете и селата.

Команди за стартиране на скрипта:

```bash
python3 main.py
```

На заден фон този скрипт изпълнява други четири - `convert_provinces.py`, `convert_municipalities.py`, `convert_entries.py`, `find_duplicates.py` и `update_entries.py`, всеки от които се грижи за някаква част от данните, които споменах по-горе.

### Скрипт "convert_provinces.py"

Този скрипт преобразува областите, извлечени от `ek_obl.json` файла, в индивидуални YAML файлове, където стойностите на `slug` и `code` се използват, за да се даде уникално име на генерирания файл (например `blagoevgrad-blg.yml`). Генерираните файлове се съхраняват в папкa с име `1.provinces`.

#### Детайли

- `ekatte` отговаря за идентификационният код на териториалната единица (ЕКАТТЕ-код), който се състои от 4+1 цифри, където последната цифра е контролна;
- `code` отговаря за идентификационният код на областта (3 букви) според спецификациите на ЕКАТТЕ.

#### Примерно съдържание

```yml
# файл blagoevgrad-blg.yml

slug: blagoevgrad
ekatte: 04279
code: BLG
locale:
  bg:
    name: Област Благоевград
    description: '...'
  en:
    name: Blagoevgrad Province
    description: '...'
```

### Скрипт "convert_municipalities.py"

Този скрипт преобразува общините, извлечени от `ek_obst.json` файла, в индивидуални YAML файлове, където стойностите на `slug` и `code` се използват, за да се даде уникално име на генерирания файл (например `aksakovo-var02.yml`). Генерираните файлове се съхраняват в папкa с име `2.municipalities`.

#### Детайли

- `ekatte` отговаря за идентификационният код на териториалната единица (ЕКАТТЕ-код), който се състои от 4+1 цифри, където последната цифра е контролна;
- `code` отговаря за идентификационният код на общината, в чийто състав влиза териториалната единица (5 знака; първите 3 букви са кода на областта; следващите 2 цифри са пореден номер на общината в областта) според спецификациите на ЕКАТТЕ;
- `region` се взима от файла `municipalities_by_region.json`, който споменах в началото;
- освен стандартното преобразуване от един формат в друг, в Python скрипта също така е добавен и специален mapping за случаите, в които едно име се среща повече от веднъж, за да се избегне дублиране и неправилно съхранение на генерираните файлове.

#### Примерно съдържание

```yml
# файл aksakovo-var02.yml

slug: aksakovo
ekatte: 00182
code: VAR02
locale:
  bg:
    name: Община Аксаково
    description: '...'
  en:
    name: Aksakovo Municipality
    description: '...'
region: varna-black-sea
```

### Скрипт "convert_entries.py"

Този скрипт преобразува градовете и селата, извлечени от `ek_atte.json` файла, в индивидуални YAML файлове, където стойностите на `slug` и `code` се използват, за да се даде уникално име на генерирания файл (например `aheloy-bgs17.yml` и `ablanitsa-blg52.yml`). Генерираните файлове се съхраняват в новосъздадени папки с имена `3.cities` (за градовете) и `4.villages` (за селата).

#### Детайли

- `ekatte` отговаря за идентификационният код на териториалната единица (ЕКАТТЕ-код), който се състои от 4+1 цифри, където последната цифра е контролна;
- `code` отговаря за идентификационният код на общината, в чийто състав влиза териториалната единица (5 знака; първите 3 букви са кода на областта; следващите 2 цифри са пореден номер на общината в областта) според спецификациите на ЕКАТТЕ.

#### Примерно съдържание за град

```yml
# файл aheloy-bgs17.yml

slug: aheloy
ekatte: 00833
code: BGS17
locale:
  bg:
    name: Град Ахелой
    description: '...'
  en:
    name: Aheloy City
    description: '...'
```

#### Примерно съдържание за село

```yml
# файл ablanitsa-blg52.yml

slug: ablanitsa
ekatte: '00014'
code: BLG52
locale:
  bg:
    name: Село Абланица
    description: '...'
  en:
    name: Ablanitsa Village
    description: '...'
```

### Скрипт "find_duplicates.py"

Този скрипт сканира всички генерирани файлове за градове и села, за да открие дублиращи се имена. Ако успее да открие такива, създава по един индивидуален текстов файл за градовете и за селата, чиито имена е открил като повтарящи се.

Файловете, които се генерират, са:

```bash
/bin/data/auto-generated/duplicated_cities.txt
/bin/data/auto-generated/duplicated_villages.txt
```

Със създадените списъци с дублиращи се имена се обхождат общините, за да се открие териториално къде спадат тези единици. Така се създава по още една двойка файлове, в които е изградена връзката между община и град/село.

Файловете, които се генерират, са:

```bash
/bin/data/auto-generated/municipalities_of_cities.json
/bin/data/auto-generated/municipalities_of_villages.json
```

### Скрипт "update_entries.py"

Изградената вече връзка от предходния скрипт се използва, за да се актуализират `slug` и `name` стойностите в YAML файловете на градовете и селата, така че да се елиминира дублирането и да се даде по-голяма яснота за коя единица става въпрос.

#### Примерно съдържание преди актуализация

```yml
# файл ablanitsa-blg52.yml

slug: ablanitsa
ekatte: '00014'
code: BLG52
locale:
  bg:
    name: Село Абланица
    description: '...'
  en:
    name: Ablanitsa Village
    description: '...'
```

#### Примерно съдържание след актуализация

```yml
# файл ablanitsa-blg52.yml

slug: ablanitsa-hadzhidimovo
ekatte: '00014'
code: BLG52
locale:
  bg:
    name: Село Абланица (общ. Хаджидимово)
    description: '...'
  en:
    name: Ablanitsa Village (Hadzhidimovo Municipality)
    description: '...'
```
